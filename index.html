<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Aura - Your Event Planning Assistant</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}

    body{
      font-family:'SF Pro Display','Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:#0a0e27;
      background:radial-gradient(ellipse at top left,#1e3a8a 0%,#0a0e27 50%),
                 radial-gradient(ellipse at bottom right,#1e40af 0%,#0a0e27 50%);
      min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;
      position:relative;overflow:hidden;
    }

    /* Enhanced glassmorphism background elements with multiple layers */
    body::before{
      content:'';position:absolute;width:800px;height:800px;
      background:radial-gradient(circle,rgba(59,130,246,0.35) 0%,rgba(37,99,235,0.2) 40%,transparent 70%);
      top:-300px;left:-300px;border-radius:50%;
      filter:blur(100px);
      animation:float 12s ease-in-out infinite;
      opacity:0.8;
    }
    body::after{
      content:'';position:absolute;width:700px;height:700px;
      background:radial-gradient(circle,rgba(147,197,253,0.3) 0%,rgba(59,130,246,0.15) 40%,transparent 70%);
      bottom:-250px;right:-250px;border-radius:50%;
      filter:blur(120px);
      animation:float 15s ease-in-out infinite reverse;
      opacity:0.6;
    }
    
    /* Additional ambient light effect */
    .ambient-light{
      position:absolute;width:600px;height:600px;
      background:radial-gradient(circle,rgba(96,165,250,0.15) 0%,transparent 60%);
      top:50%;left:50%;transform:translate(-50%,-50%);
      border-radius:50%;filter:blur(150px);
      animation:pulse-glow 8s ease-in-out infinite;
      pointer-events:none;
    }
    
    @keyframes float{
      0%,100%{transform:translate(0,0) scale(1)}
      25%{transform:translate(20px,-20px) scale(1.05)}
      50%{transform:translate(40px,20px) scale(1.08)}
      75%{transform:translate(-20px,30px) scale(1.03)}
    }
    
    @keyframes pulse-glow{
      0%,100%{opacity:0.3;transform:translate(-50%,-50%) scale(1)}
      50%{opacity:0.5;transform:translate(-50%,-50%) scale(1.1)}
    }

    .chat-container{
      width:480px;height:650px;
      background:linear-gradient(135deg,
        rgba(255,255,255,0.12) 0%,
        rgba(255,255,255,0.08) 50%,
        rgba(255,255,255,0.05) 100%);
      backdrop-filter:blur(24px) saturate(200%);
      -webkit-backdrop-filter:blur(24px) saturate(200%);
      border:1.5px solid rgba(255,255,255,0.2);
      border-radius:28px;
      box-shadow:0 8px 32px 0 rgba(0,0,0,0.4),
                 0 16px 64px 0 rgba(59,130,246,0.2),
                 0 0 0 1px rgba(255,255,255,0.1) inset,
                 0 2px 4px rgba(255,255,255,0.1) inset;
      display:flex;flex-direction:column;overflow:hidden;
      position:relative;z-index:10;
      transition:all 0.4s cubic-bezier(0.4,0,0.2,1);
    }
    
    .chat-container::before{
      content:'';position:absolute;top:0;left:0;right:0;bottom:0;
      background:linear-gradient(135deg,
        rgba(59,130,246,0.03) 0%,
        transparent 50%,
        rgba(147,197,253,0.03) 100%);
      pointer-events:none;
      border-radius:28px;
    }

    .chat-header{
      background:linear-gradient(135deg,
        rgba(59,130,246,0.25) 0%,
        rgba(37,99,235,0.15) 50%,
        rgba(29,78,216,0.2) 100%);
      backdrop-filter:blur(16px) saturate(180%);
      -webkit-backdrop-filter:blur(16px) saturate(180%);
      border-bottom:1px solid rgba(255,255,255,0.15);
      color:#fff;padding:28px 24px;text-align:center;position:relative;
      box-shadow:0 4px 24px rgba(59,130,246,0.12),
                 0 2px 8px rgba(0,0,0,0.08);
    }
    .chat-header::before{
      content:'';position:absolute;top:0;left:0;right:0;bottom:0;
      background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.04)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
      opacity:0.6;
    }
    .chat-header::after{
      content:'';position:absolute;top:0;left:0;right:0;height:2px;
      background:linear-gradient(90deg,
        transparent 0%,
        rgba(96,165,250,0.6) 20%,
        rgba(147,197,253,0.8) 50%,
        rgba(96,165,250,0.6) 80%,
        transparent 100%);
    }
    .chat-header-content{position:relative;z-index:2}
    .chat-header h1{
      font-size:32px;font-weight:700;margin-bottom:6px;
      letter-spacing:-0.5px;
      text-shadow:0 2px 16px rgba(59,130,246,0.4),
                  0 4px 32px rgba(96,165,250,0.3);
      background:linear-gradient(135deg,
        #93c5fd 0%,
        #60a5fa 50%,
        #bfdbfe 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      animation:shimmer 3s ease-in-out infinite;
    }
    @keyframes shimmer{
      0%,100%{filter:brightness(1) saturate(1)}
      50%{filter:brightness(1.1) saturate(1.2)}
    }
    .chat-header p{
      font-size:15px;opacity:.9;font-weight:500;
      color:#e0f2fe;letter-spacing:0.3px;
      text-shadow:0 1px 4px rgba(0,0,0,0.2);
    }

    .status-indicator{
      position:absolute;top:28px;right:28px;width:12px;height:12px;
      background:linear-gradient(135deg,#60a5fa 0%,#3b82f6 100%);
      border-radius:50%;
      box-shadow:0 0 24px rgba(96,165,250,0.9),
                 0 0 12px rgba(96,165,250,0.6),
                 0 0 4px rgba(255,255,255,0.8);
      z-index:3;
      animation:status-pulse 2.5s ease-in-out infinite;
    }
    .status-indicator::before{
      content:'';position:absolute;top:50%;left:50%;
      width:100%;height:100%;
      background:inherit;border-radius:50%;
      transform:translate(-50%,-50%);
      filter:blur(4px);
      opacity:0.6;
    }
    .status-indicator::after{
      content:'';position:absolute;top:-4px;left:-4px;right:-4px;bottom:-4px;
      border:1.5px solid rgba(96,165,250,0.4);border-radius:50%;
      animation:pulse-ring 2.5s cubic-bezier(0.4,0,0.6,1) infinite;
    }
    @keyframes status-pulse{
      0%,100%{opacity:1;transform:scale(1)}
      50%{opacity:0.8;transform:scale(0.95)}
    }
    @keyframes pulse-ring{
      0%{transform:scale(1);opacity:1}
      100%{transform:scale(2);opacity:0}
    }

    .chat-body{
      flex:1;padding:28px;overflow-y:auto;
      background:linear-gradient(to bottom,
        rgba(15,23,42,0.25) 0%,
        rgba(30,41,59,0.15) 50%,
        rgba(15,23,42,0.3) 100%);
      backdrop-filter:blur(8px);
      -webkit-backdrop-filter:blur(8px);
      display:flex;flex-direction:column;gap:16px;min-height:0;
      position:relative;
    }
    .chat-body::before{
      content:'';position:absolute;top:0;left:0;right:0;
      height:60px;
      background:linear-gradient(to bottom,
        rgba(59,130,246,0.05) 0%,
        transparent 100%);
      pointer-events:none;
    }

    .bot-message,.user-message,.promotion-message{
      max-width:85%;padding:18px 22px;border-radius:22px;
      font-size:14.5px;line-height:1.6;letter-spacing:0.1px;
      white-space:pre-line;
      animation:slideIn .5s cubic-bezier(0.4,0,0.2,1);
      position:relative;
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
    }
    @keyframes slideIn{
      from{opacity:0;transform:translateY(24px) scale(0.96)}
      to{opacity:1;transform:translateY(0) scale(1)}
    }

    .bot-message{
      background:linear-gradient(135deg,
        rgba(59,130,246,0.28) 0%,
        rgba(37,99,235,0.22) 100%);
      backdrop-filter:blur(12px) saturate(180%);
      -webkit-backdrop-filter:blur(12px) saturate(180%);
      border:1px solid rgba(96,165,250,0.35);
      color:#e0f2fe;align-self:flex-start;
      box-shadow:0 4px 16px rgba(59,130,246,0.18),
                 0 8px 32px rgba(59,130,246,0.12),
                 0 1px 0 rgba(255,255,255,0.1) inset;
    }
    .bot-message::before{
      content:'';position:absolute;top:0;left:0;right:0;bottom:0;
      background:linear-gradient(135deg,
        rgba(255,255,255,0.08) 0%,
        transparent 50%);
      border-radius:22px;pointer-events:none;
    }
    .bot-message:hover{
      transform:translateY(-1px);
      box-shadow:0 6px 20px rgba(59,130,246,0.22),
                 0 10px 40px rgba(59,130,246,0.15),
                 0 1px 0 rgba(255,255,255,0.15) inset;
    }
    
    .user-message{
      background:linear-gradient(135deg,
        rgba(255,255,255,0.14) 0%,
        rgba(255,255,255,0.1) 100%);
      backdrop-filter:blur(12px) saturate(160%);
      -webkit-backdrop-filter:blur(12px) saturate(160%);
      border:1px solid rgba(255,255,255,0.22);
      color:#f1f5f9;align-self:flex-end;
      box-shadow:0 4px 16px rgba(0,0,0,0.12),
                 0 8px 32px rgba(0,0,0,0.08),
                 0 1px 0 rgba(255,255,255,0.15) inset;
    }
    .user-message::before{
      content:'';position:absolute;top:0;left:0;right:0;bottom:0;
      background:linear-gradient(135deg,
        rgba(255,255,255,0.06) 0%,
        transparent 50%);
      border-radius:22px;pointer-events:none;
    }
    .user-message:hover{
      transform:translateY(-1px);
      box-shadow:0 6px 20px rgba(0,0,0,0.15),
                 0 10px 40px rgba(0,0,0,0.1),
                 0 1px 0 rgba(255,255,255,0.2) inset;
    }
    
    .promotion-message{
      background:linear-gradient(135deg,
        rgba(96,165,250,0.32) 0%,
        rgba(59,130,246,0.26) 100%);
      backdrop-filter:blur(12px) saturate(180%);
      -webkit-backdrop-filter:blur(12px) saturate(180%);
      border:1px solid rgba(147,197,253,0.4);
      border-left:3px solid rgba(96,165,250,0.8);
      color:#e0f2fe;align-self:flex-start;font-weight:500;
      box-shadow:0 4px 16px rgba(96,165,250,0.22),
                 0 8px 32px rgba(96,165,250,0.15),
                 0 1px 0 rgba(255,255,255,0.12) inset;
    }
    .promotion-message::before{
      content:'';position:absolute;top:0;left:0;right:0;bottom:0;
      background:linear-gradient(135deg,
        rgba(255,255,255,0.08) 0%,
        transparent 50%);
      border-radius:22px;pointer-events:none;
    }
    .promotion-message:hover{
      transform:translateY(-1px);
      box-shadow:0 6px 20px rgba(96,165,250,0.26),
                 0 10px 40px rgba(96,165,250,0.18),
                 0 1px 0 rgba(255,255,255,0.15) inset;
    }

    .welcome-section{
      text-align:center;padding:28px;
      background:linear-gradient(135deg,
        rgba(255,255,255,0.1) 0%,
        rgba(255,255,255,0.06) 100%);
      backdrop-filter:blur(16px) saturate(180%);
      -webkit-backdrop-filter:blur(16px) saturate(180%);
      border-radius:20px;
      border:1px solid rgba(255,255,255,0.18);
      box-shadow:0 4px 24px rgba(0,0,0,0.12),
                 0 8px 48px rgba(59,130,246,0.08),
                 0 1px 0 rgba(255,255,255,0.15) inset;
      margin-bottom:20px;
      position:relative;
      overflow:hidden;
    }
    .welcome-section::before{
      content:'';position:absolute;top:0;left:0;right:0;bottom:0;
      background:linear-gradient(135deg,
        rgba(59,130,246,0.08) 0%,
        transparent 50%,
        rgba(147,197,253,0.05) 100%);
      pointer-events:none;
    }
    .welcome-section .icon{
      font-size:36px;margin-bottom:14px;
      filter:drop-shadow(0 4px 12px rgba(96,165,250,0.4));
      animation:float-icon 3s ease-in-out infinite;
    }
    @keyframes float-icon{
      0%,100%{transform:translateY(0)}
      50%{transform:translateY(-4px)}
    }
    .welcome-section h3{
      color:#e0f2fe;margin-bottom:10px;font-size:19px;font-weight:600;
      letter-spacing:-0.2px;position:relative;
      text-shadow:0 2px 8px rgba(0,0,0,0.2);
    }
    .welcome-section p{
      color:#cbd5e1;margin-bottom:20px;line-height:1.6;
      position:relative;font-size:14.5px;
    }

    .chat-input{
      padding:24px;
      background:linear-gradient(to top,
        rgba(255,255,255,0.06) 0%,
        rgba(255,255,255,0.04) 100%);
      backdrop-filter:blur(16px) saturate(180%);
      -webkit-backdrop-filter:blur(16px) saturate(180%);
      border-top:1px solid rgba(255,255,255,0.12);
      display:flex;gap:12px;align-items:center;
      box-shadow:0 -4px 24px rgba(0,0,0,0.08);
    }
    .chat-input input{
      flex:1;padding:16px 22px;
      background:linear-gradient(135deg,
        rgba(255,255,255,0.1) 0%,
        rgba(255,255,255,0.08) 100%);
      backdrop-filter:blur(12px);
      -webkit-backdrop-filter:blur(12px);
      border:1.5px solid rgba(255,255,255,0.18);
      border-radius:50px;font-size:15px;
      outline:none;
      transition:all .3s cubic-bezier(0.4,0,0.2,1);
      color:#f1f5f9;
      box-shadow:0 2px 8px rgba(0,0,0,0.08) inset,
                 0 1px 0 rgba(255,255,255,0.1);
    }
    .chat-input input::placeholder{
      color:#94a3b8;
      font-weight:400;
    }
    .chat-input input:focus{
      border-color:rgba(96,165,250,0.7);
      background:linear-gradient(135deg,
        rgba(255,255,255,0.14) 0%,
        rgba(255,255,255,0.11) 100%);
      box-shadow:0 0 0 4px rgba(59,130,246,0.12),
                 0 2px 8px rgba(0,0,0,0.08) inset,
                 0 1px 0 rgba(255,255,255,0.15);
      transform:translateY(-1px);
    }
    .chat-input button{
      background:linear-gradient(135deg,
        rgba(59,130,246,0.85) 0%,
        rgba(37,99,235,0.85) 100%);
      backdrop-filter:blur(12px);
      -webkit-backdrop-filter:blur(12px);
      border:1.5px solid rgba(96,165,250,0.4);
      color:white;padding:16px 28px;border-radius:50px;
      cursor:pointer;font-size:15px;font-weight:600;
      transition:all .3s cubic-bezier(0.4,0,0.2,1);
      box-shadow:0 4px 16px rgba(59,130,246,0.35),
                 0 1px 0 rgba(255,255,255,0.2) inset;
      min-width:85px;
      position:relative;
      overflow:hidden;
    }
    .chat-input button::before{
      content:'';position:absolute;top:0;left:0;right:0;bottom:0;
      background:linear-gradient(135deg,
        rgba(255,255,255,0.2) 0%,
        transparent 50%);
      opacity:0;
      transition:opacity 0.3s;
    }
    .chat-input button:hover::before{opacity:1}
    .chat-input button:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(59,130,246,0.45),
                 0 12px 40px rgba(59,130,246,0.25),
                 0 1px 0 rgba(255,255,255,0.3) inset;
      background:linear-gradient(135deg,
        rgba(59,130,246,0.95) 0%,
        rgba(37,99,235,0.95) 100%);
      border-color:rgba(96,165,250,0.6);
    }
    .chat-input button:active{
      transform:translateY(0);
    }
    .chat-input button:disabled{
      opacity:.5;cursor:not-allowed;transform:none;
      box-shadow:0 4px 16px rgba(59,130,246,0.2);
    }

    .connection-status{
      position:fixed;top:20px;left:50%;transform:translateX(-50%);
      background:rgba(59,130,246,0.95);
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
      color:white;padding:12px 24px;border-radius:50px;
      font-size:14px;font-weight:600;z-index:1000;display:none;
      box-shadow:0 8px 25px rgba(59,130,246,0.4);
      border:1px solid rgba(96,165,250,0.3);
    }
    .connection-status.success{
      background:rgba(96,165,250,0.95);
      box-shadow:0 8px 25px rgba(96,165,250,0.4);
    }
    .connection-status.error{
      background:rgba(239,68,68,0.95);
      box-shadow:0 8px 25px rgba(239,68,68,0.4);
    }

    .typing-indicator{
      display:flex;align-items:center;gap:8px;padding:16px 20px;
      background:rgba(255,255,255,0.08);
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
      border:1px solid rgba(255,255,255,0.15);
      border-radius:20px;align-self:flex-start;max-width:85%;
    }
    .typing-dots{display:flex;gap:4px}
    .typing-dot{
      width:8px;height:8px;background:#60a5fa;border-radius:50%;
      animation:typing 1.6s infinite ease-in-out;
    }
    .typing-dot:nth-child(2){animation-delay:.2s}.typing-dot:nth-child(3){animation-delay:.4s}
    @keyframes typing{
      0%,80%,100%{transform:scale(.8);opacity:.5}
      40%{transform:scale(1.2);opacity:1}
    }

    .purchase-button{
      display:inline-block;
      background:linear-gradient(135deg,
        rgba(59,130,246,0.85) 0%,
        rgba(37,99,235,0.85) 100%);
      backdrop-filter:blur(12px);
      -webkit-backdrop-filter:blur(12px);
      border:1.5px solid rgba(96,165,250,0.5);
      color:white !important;padding:14px 28px;border-radius:50px;
      text-decoration:none !important;
      font-weight:700;font-size:14.5px;margin:10px 0;
      transition:all .3s cubic-bezier(0.4,0,0.2,1);
      box-shadow:0 4px 16px rgba(59,130,246,0.4),
                 0 1px 0 rgba(255,255,255,0.2) inset;
      cursor:pointer;
      text-align:center;min-width:190px;min-height:48px;
      position:relative;overflow:hidden;
      letter-spacing:0.3px;
    }
    .purchase-button::before{
      content:'';position:absolute;top:0;left:0;right:0;bottom:0;
      background:linear-gradient(135deg,
        rgba(255,255,255,0.2) 0%,
        transparent 50%);
      opacity:0;
      transition:opacity 0.3s;
    }
    .purchase-button:hover::before{opacity:1}
    .purchase-button:hover{
      transform:translateY(-3px);
      box-shadow:0 8px 24px rgba(59,130,246,0.5),
                 0 16px 48px rgba(59,130,246,0.3),
                 0 1px 0 rgba(255,255,255,0.3) inset;
      background:linear-gradient(135deg,
        rgba(59,130,246,0.95) 0%,
        rgba(37,99,235,0.95) 100%);
      color:white !important;
      border-color:rgba(96,165,250,0.7);
    }
    .purchase-button:active{transform:translateY(-1px)}

    .chat-body::-webkit-scrollbar{width:10px}
    .chat-body::-webkit-scrollbar-track{
      background:rgba(255,255,255,0.03);
      border-radius:10px;
      margin:8px 0;
    }
    .chat-body::-webkit-scrollbar-thumb{
      background:linear-gradient(135deg,
        rgba(96,165,250,0.4) 0%,
        rgba(59,130,246,0.4) 100%);
      border-radius:10px;
      border:2px solid rgba(255,255,255,0.05);
      box-shadow:0 2px 8px rgba(59,130,246,0.2) inset;
      transition:all 0.3s ease;
    }
    .chat-body::-webkit-scrollbar-thumb:hover{
      background:linear-gradient(135deg,
        rgba(96,165,250,0.6) 0%,
        rgba(59,130,246,0.6) 100%);
      border-color:rgba(255,255,255,0.1);
      box-shadow:0 2px 12px rgba(59,130,246,0.3) inset;
    }

    .bot-message a:not(.purchase-button){
      color:#93c5fd;text-decoration:underline;font-weight:600;
    }
    .bot-message a:not(.purchase-button):hover{color:#bfdbfe}

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      body{padding:0}
      .chat-container{
        width:100vw;height:100vh;border-radius:0;max-height:100vh;border:none;
        border-left:1px solid rgba(255,255,255,0.1);
        border-right:1px solid rgba(255,255,255,0.1);
      }
      .chat-header{padding:20px 15px 15px 15px;padding-top:max(20px, env(safe-area-inset-top))}
      .chat-header h1{font-size:24px}
      .chat-header p{font-size:14px}
      .chat-body{padding:15px;gap:12px}
      .bot-message,.user-message,.promotion-message{
        max-width:95%;padding:12px 16px;font-size:14px;border-radius:16px;
      }
      .welcome-section{padding:20px 15px;margin-bottom:15px;border-radius:12px}
      .welcome-section .icon{font-size:28px;margin-bottom:10px}
      .welcome-section h3{font-size:16px;margin-bottom:8px}
      .welcome-section p{font-size:14px;line-height:1.5;margin-bottom:15px}
      .chat-input{
        padding:15px;padding-bottom:max(15px, calc(15px + env(safe-area-inset-bottom)));gap:10px;
      }
      .chat-input input{padding:14px 18px;font-size:16px;border-radius:25px}
      .chat-input button{
        padding:14px 20px;font-size:14px;border-radius:25px;min-width:70px;min-height:44px;
      }
      .purchase-button{
        padding:12px 20px;font-size:14px;min-width:160px;margin:8px 0;
        border-radius:25px;min-height:44px;
      }
      .typing-indicator{padding:12px 16px;border-radius:16px}
      .status-indicator{top:20px;right:20px;width:12px;height:12px}
      .connection-status{top:10px;padding:8px 16px;font-size:12px;border-radius:20px}
    }

    @media (min-width: 769px) and (max-width: 1024px) {
      .chat-container{width:600px;height:750px}
      .chat-header{padding:28px 24px}
      .chat-body{padding:28px}
      .chat-input{padding:24px}
    }

    @media (min-width: 1025px) {
      .chat-container{width:480px;height:650px}
      .chat-input button:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(59,130,246,0.4)}
      .purchase-button:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(59,130,246,0.6)}
      .bot-message,.user-message,.promotion-message{transition:all .3s ease}
    }

    @supports (-webkit-touch-callout: none) {
      .chat-container{height:100vh;height:-webkit-fill-available}
      .chat-input input{font-size:16px;border-radius:25px}
    }

    @media screen and (max-width: 768px) {
      .chat-input input:focus{transform:none}
    }
  </style>
</head>
<body>
<div class="connection-status" id="connectionStatus">Connecting...</div>
<div class="chat-container">
<div class="chat-header">
<div class="status-indicator"></div>
<div class="chat-header-content">
<h1>Aura</h1>
<p>Your Event Planning Assistant</p>
</div>
</div>
<div class="chat-body" id="chat-body">
<div class="welcome-section">
<div class="icon">‚ú®</div>
<h3>Welcome to Uptown Studio Lounge!</h3>
<p>I'm Aura, your event planning assistant. Let me help you create the perfect celebration! üéâ</p>
</div>
</div>
<div class="chat-input">
<input type="text" id="user-input" placeholder="Type your message here..." />
<button onclick="sendMessage()" id="send-button">Send</button>
</div>
</div>

<script type="module">
// ===== AURA CHATBOT CONFIGURATION =====
const CHATBOT_ID = "c5e4c04e-da33-4025-ab82-1b6d7affaf9c"; // You'll need to add this after creating in Supabase
const BACKEND_URL = "https://hsrpibsdfzzzvfmfakqu.supabase.co/functions/v1/chatbot-proxy";

// State variables
let sessionId = crypto.randomUUID();
let currentThreadId = null;
let retryCount = 0;
const MAX_RETRIES = 2;

console.log('‚ú® Aura Event Planning Assistant initializing...');

// ===== PERFORMANCE OPTIMIZATION: Pre-create thread on load =====
async function initializeThread() {
  try {
    console.log('‚ö° Pre-warming thread for faster first response...');
    await createThread();
    console.log('‚úÖ Thread ready! First message will be instant.');
  } catch (error) {
    console.log('‚ö†Ô∏è Thread pre-warming failed, will create on first message');
  }
}

// UI Functions
function showConnectionStatus(message, type = 'info') {
  const status = document.getElementById('connectionStatus');
  status.textContent = message;
  status.className = `connection-status ${type}`;
  status.style.display = 'block';
  setTimeout(() => {
    status.style.display = 'none';
  }, 3000);
}

function addMessage(content, className = "bot-message") {
  const chatBody = document.getElementById("chat-body");
  const msg = document.createElement("div");
  msg.className = className;

  if (className === "bot-message" || className === "promotion-message") {
    const linkRegex = /\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g;
    let processedContent = content.replace(linkRegex, (match, text, url) => {
      if (url.includes('stripe.com') || url.includes('booking') || url.includes('reserve') || url.includes('buy')) {
        return `<a href="${url}" target="_blank" class="purchase-button">${text}</a>`;
      } else {
        return `<a href="${url}" target="_blank" style="color: #93c5fd; text-decoration: underline;">${text}</a>`;
      }
    });

    processedContent = processedContent.replace(
      /(https?:\/\/[^\s\)]+)(?![^<]*<\/a>)/g,
      '<a href="$1" target="_blank" style="color: #93c5fd; text-decoration: underline;">$1</a>'
    );

    msg.innerHTML = processedContent;
  } else {
    msg.textContent = content;
  }

  chatBody.appendChild(msg);
  chatBody.scrollTop = chatBody.scrollHeight;
  return msg;
}

function showTypingIndicator() {
  const chatBody = document.getElementById("chat-body");
  const typingDiv = document.createElement("div");
  typingDiv.className = "typing-indicator";
  typingDiv.id = "typing-indicator";

  const dotsContainer = document.createElement("div");
  dotsContainer.className = "typing-dots";

  for (let i = 0; i < 3; i++) {
    const dot = document.createElement("div");
    dot.className = "typing-dot";
    dotsContainer.appendChild(dot);
  }

  typingDiv.appendChild(dotsContainer);
  chatBody.appendChild(typingDiv);
  chatBody.scrollTop = chatBody.scrollHeight;
  return typingDiv;
}

function removeTypingIndicator() {
  const typing = document.getElementById("typing-indicator");
  if (typing) {
    typing.remove();
  }
}

// Backend API Functions with improved error handling
async function callBackend(action, payload = {}, attempt = 1) {
  try {
    console.log(`üîÑ Calling backend: ${action} (attempt ${attempt}/${MAX_RETRIES + 1})`);
    
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 45000); // 45 second timeout
    
    const response = await fetch(BACKEND_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        chatbot_id: CHATBOT_ID,
        action: action,
        ...payload
      }),
      signal: controller.signal
    });

    clearTimeout(timeoutId);

    if (!response.ok) {
      const errorText = await response.text();
      console.error(`‚ùå Backend error ${response.status}:`, errorText);
      throw new Error(`Backend error: ${response.status} - ${errorText}`);
    }

    const result = await response.json();
    
    if (!result.success) {
      console.error('‚ùå Backend returned error:', result.error);
      throw new Error(result.error || 'Backend request failed');
    }

    console.log(`‚úÖ Backend call successful: ${action}`);
    return result.data;
    
  } catch (error) {
    if (error.name === 'AbortError') {
      console.error('‚ùå Request timeout after 45 seconds');
      throw new Error('Response timeout - the AI is taking too long to respond');
    }
    
    // Retry logic for network errors
    if (attempt <= MAX_RETRIES && (error.message.includes('fetch') || error.message.includes('network'))) {
      console.log(`üîÑ Retrying... (${attempt}/${MAX_RETRIES})`);
      await new Promise(resolve => setTimeout(resolve, 1000 * attempt)); // Exponential backoff
      return callBackend(action, payload, attempt + 1);
    }
    
    console.error('‚ùå Backend call failed:', error);
    throw error;
  }
}

async function createThread() {
  try {
    const thread = await callBackend('create_thread');
    currentThreadId = thread.id;
    console.log('‚úÖ Thread created:', currentThreadId);
    return currentThreadId;
  } catch (error) {
    console.error('‚ùå Error creating thread:', error);
    throw error;
  }
}

async function sendToBackend(message) {
  try {
    if (!currentThreadId) {
      console.log('üìù Creating new thread...');
      await createThread();
    }

    console.log('üì§ Sending message to backend...');
    const response = await callBackend('send_message', {
      message: message,
      thread_id: currentThreadId
    });

    console.log('‚úÖ Response received from backend');
    return response;
    
  } catch (error) {
    console.error('‚ùå Error with backend:', error);
    
    // If thread error, try creating new thread once
    if (error.message.includes('thread') && retryCount < 1) {
      retryCount++;
      console.log('üîÑ Thread issue detected, creating new thread...');
      currentThreadId = null;
      return sendToBackend(message);
    }
    
    throw error;
  }
}

async function saveChatHistory(userMessage, botResponse) {
  try {
    await callBackend('save_chat', {
      message: userMessage,
      response: botResponse,
      session_id: sessionId
    });
    console.log('üíæ Chat history saved');
  } catch (error) {
    console.error("‚ö†Ô∏è Error saving chat history:", error);
    // Don't throw - this is not critical
  }
}

async function sendMessage() {
  const input = document.getElementById("user-input");
  const message = input.value.trim();
  if (message === "") return;

  const sendButton = document.getElementById("send-button");
  sendButton.disabled = true;
  retryCount = 0; // Reset retry count for new message

  addMessage(message, "user-message");
  input.value = "";
  showTypingIndicator();

  try {
    console.log('üí¨ Processing message:', message);
    const response = await sendToBackend(message);
    removeTypingIndicator();
    addMessage(response, "bot-message");
    await saveChatHistory(message, response);
    console.log('‚úÖ Message processed successfully');
  } catch (error) {
    console.error("‚ùå Message processing error:", error);
    removeTypingIndicator();
    
    let errorMessage = "I apologize, but I'm having trouble connecting right now. ";
    
    if (error.message.includes('timeout')) {
      errorMessage += "The response is taking longer than expected. Please try again with a shorter question, or call us directly at (956) 562-4646.";
    } else if (error.message.includes('network') || error.message.includes('fetch')) {
      errorMessage += "Please check your internet connection and try again.";
    } else {
      errorMessage += "Please try again in a moment. If the issue persists, call us at (956) 562-4646.";
    }
    
    addMessage(errorMessage, "bot-message");
  }

  sendButton.disabled = false;
  input.focus();
}

// Initialize on page load
document.addEventListener("DOMContentLoaded", async function () {
  console.log('‚ú® DOM loaded, initializing Aura...');

  // Pre-warm thread for faster first response
  initializeThread();

  // Add automatic welcome message after a short delay
  setTimeout(() => {
    addMessage("Welcome to Uptown Studio Lounge! A cozy, modern space for your most special celebrations. Ask me anything ‚Äî I'm here to help you plan your perfect event. Hablo Espa√±ol.", "bot-message");
  }, 800);

  const input = document.getElementById("user-input");
  input.addEventListener("keydown", function (event) {
    if (event.key === "Enter") {
      event.preventDefault();
      sendMessage();
    }
  });

  input.focus();
  console.log('‚úÖ Aura event planning assistant ready!');
});

// Make functions available globally
window.sendMessage = sendMessage;
</script>
</body>
</html>
